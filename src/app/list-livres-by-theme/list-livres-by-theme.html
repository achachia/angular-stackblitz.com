<app-header></app-header>

<!-- Loader pendant le chargement -->
<div *ngIf="isLoading" class="loader-container">
  <div class="spinner"></div>
</div>

<div class="container" *ngIf="!isLoading">
  <h1 class="title">Les livres ({{nomTheme}})</h1>

  <!-- Filters -->
  <div class="filters" *ngIf="listLivresTemp.length > 0">
    <!-- Champ de recherche -->
    <input
      type="text"
      placeholder="Rechercher un livre..."
      [(ngModel)]="searchText"
      (input)="applyFilters()"
    />
    <!-- Filtres par année -->
    <select
      [(ngModel)]="selectedPeriode"
      placeholder="Filtrer par année"
      (change)="applyFiltersYear()"
    >
      <option value="" selected>-- Filtrer par année --</option>
      <option *ngFor="let annee of periodes" [value]="annee">
        {{ annee }}
      </option>
    </select>

    <select [(ngModel)]="selectedType" (change)="applyFiltersType()">
      <option value="">-- Filtrer par type --</option>
      <option *ngFor="let t of types" [value]="t">{{ t }}</option>
    </select>
  </div>

  <div *ngIf="listLivres.length === 0" class="no-lists-message">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="120"
      height="120"
      fill="none"
      viewBox="0 0 64 64"
      stroke="#999"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M32 12v40M12 32h40" />
      <circle cx="32" cy="32" r="30" />
    </svg>
    <p>Aucun livre disponible pour le moment.</p>
  </div>

  <div class="magazine-grid" *ngIf="listLivres.length > 0">
    <div class="magazine-card" *ngFor="let livre of listLivres; let i = index">
      <div class="cover-container">
        <img
          [src]="livre.cover"
          alt="{{ livre.titre }}"
          class="magazine-cover"
        />

        <!-- Icône Favori -->

        <div class="favorite-icon" (click)="toggleFavori(livre)">
          <!-- SVG étoile (remplie ou vide selon favoris) -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            fill="currentColor"
            [attr.fill]="isFavori(livre) ? 'red' : '#ffffffcc'"
            viewBox="0 0 24 24"
            class="star-icon"
          >
            <path
              d="M12 17.27L18.18 21l-1.63-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.45 4.73L5.82 21z"
            />
          </svg>
        </div>
      </div>

      <div class="magazine-info">
        <h2 class="magazine-title">
          <i class="fas fa-book"></i> {{ livre.titre }}
        </h2>
        <p class="magazine-type">
          <i class="fas fa-tag"></i> Année : <strong>{{ livre.year }}</strong>
        </p>
        <p class="magazine-type">
          <i class="fas fa-tag"></i> Auteur :
          <strong>{{ livre.auteur }}</strong>
        </p>
        <p class="magazine-type">
          <i class="fas fa-tag"></i> Langue :
          <strong>{{ livre.langue }}</strong>
        </p>
        <p class="magazine-pages">
          <i class="fas fa-file-alt"></i> {{ livre.nbr_pages }} pages
        </p>

        <div
          class="circular-progress-container"
          *ngIf="getProgress(livre.token) > 0"
        >
          <svg class="progress-ring" width="60" height="60">
            <circle
              class="progress-ring__background"
              stroke="#e5e7eb"
              stroke-width="6"
              fill="transparent"
              r="26"
              cx="30"
              cy="30"
            />
            <circle
              class="progress-ring__circle"
              [attr.stroke-dasharray]="circumference"
              [attr.stroke-dashoffset]="getDashOffset(livre.token)"
              stroke="#3b82f6"
              stroke-width="6"
              fill="transparent"
              r="26"
              cx="30"
              cy="30"
            />
          </svg>
          <div class="progress-text">{{ getProgress(livre.token) }}%</div>
        </div>

        <button class="btn-read" (click)="selectLivre(i, livre)">
          <i class="fas fa-book-open"></i> Actions
        </button>
      </div>
      <div *ngIf="livre.traductionEnCours" class="progress-container">
        <label>Taux progression de la traduction globale :</label>
        <div class="progress-bar">
          <div
            class="progress-bar-fill"
            [style.width.%]="livre.tauxPagesTranslate"
          ></div>
        </div>
        <span>{{ livre.tauxPagesTranslate }}%</span>
      </div>
      <div
        *ngIf="livre.traductionEnCours && livre.tauxPagesTranslate < 100"
        class="progress-container"
      >
        <label>Progression de la traduction en cours :</label>
        <div class="progress-bar">
          <div
            class="progress-bar-fill"
            [style.width.%]="livre.progressionTraduction"
          ></div>
        </div>
        <span>{{ livre.progressionTraduction }}%</span>
      </div>
    </div>
    <div
      class="magazine-grid"
      style="margin-left: 25%; margin-right: 25%"
    ></div>
    <div
      class="magazine-grid"
      style="margin-left: 25%; margin-right: 25%"
    ></div>
    <div
      class="magazine-grid"
      style="margin-left: 25%; margin-right: 25%"
    ></div>
  </div>
</div>

<!-- Menu d'actions ActionSheet -->
<div
  class="actionsheet-backdrop"
  *ngIf="isModalOpenSheetAction"
  (click)="closeActionSheet()"
></div>
<div class="actionsheet" *ngIf="isModalOpenSheetAction">
  <h3>Actions pour : {{ selectedLivre.titre }}</h3>
  <!-- <button (click)="actionLire()">Lire</button>
  <button (click)="actionPartager()">Partager</button>
  <button (click)="actionFavori()">
    {{ isFavori(selectedLivre) ? 'Retirer des favoris' : 'Ajouter aux favoris'
    }}
  </button>
  <button class="btn-cancel" (click)="closeActionSheet()">Annuler</button>-->

  <button (click)="actionLire()"><i class="fas fa-book-open"></i> Lire</button>
  <button (click)="editdataLivre()">
    <i class="fas fa-edit"></i> Modifier infos livre
  </button>
  <button (click)="getdataSommaireLivre()">
    <i class="fas fa-book-open"></i> Explorer le sommaire
  </button>
  <button (click)="actionPartager()">
    <i class="fas fa-share-alt"></i> Partager
  </button>
  <button (click)="actionFavori()">
    <i [class]="isFavori(selectedLivre) ? 'fas fa-star' : 'far fa-star'"></i>
    {{ isFavori(selectedLivre) ? 'Retirer des favoris' : 'Ajouter aux favoris'
    }}
  </button>
  <button (click)="actionListeLectureLivre()">
    <i [class]="isFavori(selectedLivre) ? 'fas fa-star' : 'far fa-star'"></i>
    {{ isFavori(selectedLivre) ? 'Retirer d\'une liste(Livres)' : 'Ajouter à une
    liste (Livres)' }}
  </button>
  <button (click)="actionTranslateLivre()">
    <i class="fas fa-book-open"></i>
    Traduire le livre
  </button>
  <button class="btn-cancel" (click)="closeActionSheet()">
    <i class="fas fa-times"></i> Annuler
  </button>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="isListModalOpen" (click)="closeListModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3 class="modal-title">Listes (Livres) Disponibles</h3>
    <ul class="list-container">
      <li *ngFor="let list of listsLectureLivres" class="list-item">
        <span class="list-name">{{ list.titre }}</span>
        <button class="assign-btn" (click)="assignLivreToList(list)">
          Affecter
        </button>
      </li>
    </ul>
    <button class="close-btn" (click)="closeListModal()">Fermer</button>
  </div>
</div>

<div class="toast-notification" *ngIf="toastMessage" [@fadeInOut]>
  {{ toastMessage }}
</div>

<!-- Affiche le modal si la session est expirée -->
<div class="modal-backdrop" *ngIf="showSessionExpiredModa"></div>
<div class="session-modal" *ngIf="showSessionExpiredModa">
  <h2>Session expirée</h2>
  <p>Votre session a expiré.<br />Veuillez vous reconnecter pour continuer.</p>
  <button (click)="goToLogin()">Se connecter</button>
</div>

<div
  class="toast-notification"
  *ngIf="toastMessage"
  [ngClass]="['toast-' + toastType]"
  [@fadeInOut]
>
  {{ toastMessage }}
</div>

<!-- Modal Edit livre -->
<div
  class="modal-backdrop"
  *ngIf="isModalEditLivre"
  (click)="closeModalEditLivre()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3 class="modal-title">Editer le livre</h3>

    <form (ngSubmit)="submitFormEditLivre()" #FormEditLivre="ngForm">
      <div class="form-group">
        <label for="nameLivre">Nom:</label><br />
        <input
          type="text"
          id="nameLivre"
          name="nameLivre"
          [(ngModel)]="selectedLivre.titre"
          required
          minlength="3"
          #nameInput="ngModel"
          class="form-control"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            Le nom de livre est requis.
          </div>
          <div *ngIf="nameInput.errors?.['minlength']">
            Le nom doit contenir au moins 3 caractères.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Année:</label><br />
        <input
          type="number"
          id="yearLivre"
          name="yearLivre"
          [(ngModel)]="selectedLivre.year"
          required
          minlength="4"
          #nameInput="ngModel"
          class="form-control"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            L'année du livre est requis.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Couverture:</label><br />
        <input
          type="text"
          id="coverLivre"
          name="coverLivre"
          [(ngModel)]="selectedLivre.cover"
          required
          minlength="4"
          #nameInput="ngModel"
          class="form-control"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            La couverture du livre est requis.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Nombre de pages:</label><br />
        <input
          type="number"
          id="nbrPagesLivre"
          name="nbrPagesLivre"
          [(ngModel)]="selectedLivre.nbr_pages"
          required
          #nameInput="ngModel"
          class="form-control"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            Le nombre de pages du livre est requis.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Auteur:</label><br />
        <input
          type="text"
          id="auteurLivre"
          name="auteurLivre"
          [(ngModel)]="selectedLivre.auteur"
          required
          minlength="4"
          #nameInput="ngModel"
          class="form-control"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            L'auteur du livre est requis.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Thème:</label><br />
        <input
          type="text"
          id="themeLivre"
          name="themeLivre"
          [(ngModel)]="selectedLivre.keyTheme"
          required
          minlength="4"
          #nameInput="ngModel"
          class="form-control"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            Le thème du livre est requis.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Langue:</label><br />
        <input
          type="text"
          id="langueLivre"
          name="langueLivre"
          [(ngModel)]="selectedLivre.langue"
          required
          minlength="4"
          #nameInput="ngModel"
          class="form-control"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            La langue du livre est requis.
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Description&nbsp;:</label>
        <angular-editor
          [(ngModel)]="selectedLivre.subtitle"
          [config]="config"
          name="subtitleLivre"
        ></angular-editor>
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            La description du livre est requise.
          </div>
        </div>
      </div>
      <br /><br />
      <div class="form-actions" style="margin-top: 2%">
        <button
          type="submit"
          [disabled]="!FormEditLivre.valid"
          class="save-btn"
        >
          Enregistrer
        </button>

        <button
          type="button"
          class="cancel-btn"
          (click)="closeModalEditLivre()"
        >
          Annuler
        </button>
      </div>
    </form>

    <button class="close-btn" (click)="closeModalEditLivre()">Fermer</button>
  </div>
</div>

<div
  class="modal-backdrop"
  *ngIf="isListModalOpenSommaireLivre"
  (click)="closeShowSommaireLivre()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3 class="modal-title">Le sommaire</h3>

    <ul class="liste-sommaire">
      <li
        *ngFor="let item of selectedLivre.listSommaires; let i = index"
        class="item-sommaire"
      >
        <div class="texte-sommaire">
          <span style="font-weight: bold; font-size: 1.5rem; color: blue"
            >{{ item.titre }}</span
          >

          <div class="resume-sommaire" [innerHTML]="item.resumeText"></div>
        </div>
      </li>
    </ul>

    <button
      type="button"
      (click)="closeShowSommaireLivre()"
      class="close-btn"
      style="margin-left: 2%"
    >
      Fermer
    </button>
  </div>
</div>
