<app-header></app-header>
<div class="magazine-viewer">
  <div>
    <h2>{{nom_magazine}}</h2>
    <h2 style="text-align: center">Page {{(currentIndex+1)}}</h2>
  </div>

  <!-- Menu d√©roulant en haut √† droite -->
  <div class="top-right-menu">
    <button class="menu-btn" (click)="toggleMenu()">‚ò∞</button>

    <div class="menu-dropdown" *ngIf="menuOpen">
      <ul style="width: 500px">
        <li (click)="openFullscreen()">üì∫ Plein √©cran</li>
        <li (click)="toggleZoom()">üîç Zoom</li>
        <li (click)="chatVisible = true">üí¨ Chatbot</li>
        <li (click)="openListModal(); menuOpen = false">
          üìã Associer √† une liste
        </li>
        <li (click)="getOCRPage(); menuOpen = false">üìã R√©cup√©rer le OCR</li>
      </ul>
    </div>
  </div>

  <!-- Image principale -->
  <div
    class="main-image-container"
    (swipeleft)="nextPage()"
    (swiperight)="prevPage()"
    [class.zoomed]="isZoomed"
    (click)="toggleZoom()"
  >
    <pinch-zoom>
      <img [src]="currentPage" alt="Page" class="main-image" [@fadeImage] />
    </pinch-zoom>
    <button class="nav-button prev" (click)="prevPage()">‚Äπ</button>
    <button class="nav-button next" (click)="nextPage()">‚Ä∫</button>
  </div>

  <!-- Slider de miniatures -->
  <div class="thumbnail-slider">
    <img
      *ngFor="let page of listPagesByCycleMagazine; let i = index"
      [src]="page.url"
      [class.active]="i === currentIndex"
      (click)="goToPage(i)"
      class="thumbnail"
      alt="aper√ßu page {{ i + 1 }}"
    />
  </div>
</div>

<!-- Bouton flottant pour ouvrir -->
<button class="chatbot-float-btn" (click)="chatVisible = !chatVisible">
  üí¨
</button>

<!-- Fen√™tre popup du chatbot -->
<div class="chatbot-popup" *ngIf="chatVisible">
  <div class="chatbot-header">
    <span class="chatbot-title">Assistant MEGABOOK</span>
    <button class="chatbot-close-btn" (click)="chatVisible = false">‚úñ</button>
    <!-- Fen√™tre popup du chatbot -->
    <div class="chatbot-model-select">
      <label for="model-select">Mod√®le :</label>
      <select
        id="model-select"
        [(ngModel)]="selectedModel"
        (change)="onModelChange()"
      >
        <option *ngFor="let model of chatbotModels" [value]="model.value">
          {{ model.label }}
        </option>
      </select>
    </div>
  </div>

  <iframe
    [src]="chatbotUrlSafe"
    class="chatbot-frame-popup"
    frameborder="0"
    allow="microphone; camera"
  ></iframe>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="isListModalOpen" (click)="closeListModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3 class="modal-title">Listes Disponibles</h3>
    <ul class="list-container">
      <li *ngFor="let list of listsLecture" class="list-item">
        <span class="list-name">{{ list.titre }}</span>
        <button class="assign-btn" (click)="assignPageToList(list)">
          Affecter
        </button>
      </li>
    </ul>
    <button class="close-btn" (click)="closeListModal()">Fermer</button>
  </div>
</div>

<div class="toast-notification" *ngIf="toastMessage" [@fadeInOut]>
  {{ toastMessage }}
</div>

<!-- Affiche le modal si la session est expir√©e -->
<div class="modal-backdrop" *ngIf="showSessionExpiredModa"></div>
<div class="session-modal" *ngIf="showSessionExpiredModa">
  <h2>Session expir√©e</h2>
  <p>Votre session a expir√©.<br />Veuillez vous reconnecter pour continuer.</p>
  <button (click)="goToLogin()">Se connecter</button>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="isListModalOpen" (click)="closeListModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3 class="modal-title">Listes Disponibles</h3>
    <ul class="list-container">
      <li *ngFor="let list of listsLecture" class="list-item">
        <span class="list-name">{{ list.titre }}</span>
        <button class="assign-btn" (click)="assignPageToList(list)">
          Affecter
        </button>
      </li>
    </ul>
    <button class="close-btn" (click)="closeListModal()">Fermer</button>
  </div>
</div>

<div
  class="toast-notification"
  *ngIf="toastMessage"
  [ngClass]="['toast-' + toastType]"
  [@fadeInOut]
>
  {{ toastMessage }}
</div>

<!-- Affiche le modal si la session est expir√©e -->
<div class="modal-backdrop" *ngIf="showSessionExpiredModa"></div>
<div class="session-modal" *ngIf="showSessionExpiredModa">
  <h2>Session expir√©e</h2>
  <p>Votre session a expir√©.<br />Veuillez vous reconnecter pour continuer.</p>
  <button (click)="goToLogin()">Se connecter</button>
</div>

<!-- Modal -->
<div
  class="modal-backdrop"
  *ngIf="isListModalOpenEdit"
  (click)="closeListModalEdit()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3 class="modal-title">Ajouter une note</h3>

    <form (ngSubmit)="editNoteForm()" #listForm="ngForm">
      <div class="form-group">
        <label for="NoteIdSelect">La note :</label>
        <select
          id="NoteIdSelect"
          name="NoteIdSelect"
          [(ngModel)]="note_id"
          required
          #nameInput="ngModel"
          class="form-control"
          (change)="onSelectNoteChange($event)"
        >
          <option value="" disabled selected>S√©lectionnez une note</option>
          <option *ngFor="let note of listsNotes" [value]="note._id">
            {{ note.titre }}
          </option>
        </select>
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">La note est requise.</div>
        </div>
      </div>

      <div class="form-group">
        <label for="listName">Source de la note:</label>
        <input
          type="text"
          id="source"
          name="listName"
          [(ngModel)]="source"
          required
          minlength="3"
          #nameInput="ngModel"
          class="form-control"
          [value]="source"
        />
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">
            Le nom de la source est requis.
          </div>
          <div *ngIf="nameInput.errors?.['minlength']">
            Le nom doit contenir au moins 3 caract√®res.
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="listName">Note&nbsp;:</label>
        <textarea
          id="note"
          name="note"
          [(ngModel)]="note"
          required
          minlength="3"
          #nameInput="ngModel"
          class="form-control"
          rows="10"
        ></textarea>
        <div
          *ngIf="nameInput.invalid && (nameInput.dirty || nameInput.touched)"
          class="validation-message"
        >
          <div *ngIf="nameInput.errors?.['required']">La note est requise.</div>
          <div *ngIf="nameInput.errors?.['minlength']">
            La note doit contenir au moins 3 caract√®res.
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="!listForm.valid" class="save-btn">
          Enregistrer
        </button>
        <button
          type="button"
          (click)="confirmActionOcrNote()"
          class="save-btn"
          style="margin-left: 2%"
        >
          Continuer OCR
        </button>
        <button type="button" class="cancel-btn" (click)="closeListModalEdit()">
          Annuler
        </button>
      </div>
    </form>

    <button class="close-btn" (click)="closeListModalEdit()">Fermer</button>
  </div>
</div>

<!-- Modal confirmation Suivi Ocr -->
<div
  class="confirm-backdrop"
  *ngIf="isConfirmOpenOcr"
  (click)="cancelSuiviOcr()"
>
  <div class="confirm-modal" (click)="$event.stopPropagation()">
    <h3>Confirmation</h3>
    <p>Vous voulez continuer le OCR des pages ?</p>
    <div class="confirm-actions">
      <button class="btn btn-cancel" (click)="cancelSuiviOcr()">Annuler</button>
      <button class="btn btn-confirm" (click)="confirmActionOcrNote()">
        Continuer
      </button>
    </div>
  </div>
</div>
